# Blender to Godot (BTG) Class Importer
A simple pipeline for Godot class and variable assignments from within Blender.

## Installation
* Download the latest BTG release and extract the zip
* In Blender, go to `Edit > Preferences > Add-ons`
  * Select the dropdown on the top right and click "Install from Disk..."
  * Navigate to `btg_entity_exporter.zip` and click "Install from Disk"
* Extract `btg_entity_importer.zip` into the `addons/` folder of your Godot project
  * Follow the steps in Godot's [installing plugins](https://docs.godotengine.org/en/stable/tutorials/plugins/editor/installing_plugins.html) page

## Overview
The pipeline uses two JSON files:
* `entity_template.json`: A file (written by you) that defines what classes and variables you want to expose to Blender
* `entity_definition.json`: A file generated by the Blender add-on and used in Godot's importer to assign classes and variables to your `.blend` or your exported `.glb/.gltf` model on import

The workflow is typically:
* Write the `entity_template.json` for your Godot project, updating it when you want to expose new classes/variables
  * Updates will need to be re-imported into Blender
* Once you're finished in Blender, export your model and hit the `Write BTG import JSON` button
  * Note: exporting your model does not write `entity_definition.json`, exporting and importing the entity information is a separate process
* In Godot, add the path of `entity_definition.json` to your `.blend` or `.glb/.gltf` model import settings and re-import

## Writing the Entity Template JSON
<!-- In the entity template, Godot classes can be exposed to Blender by entering their class name as a key. Every entity definition has a "uid" field (this can also be the path to the .gd or .tscn file) and a "variables" field. Within the "variables" field, variables can be defined with a Godot type, default value, and (optional) description. Enums also require an "options" field to be defined. "uid" can be skipped for built-in Godot classes. -->

#### `entity_template.json` Format
```
{
    "GodotClassName": {
        "uid": "uid://someUID",
        "variables": {
            "var_name": {
                "type": "SomeType",
                "default": default,
                "description": "Description string",
                "options": {"String option 1": 0, "String option 2": 1, ...}
            },
            ...
        }
    },
    ...
}
```
* GodotClassName: The name of the class in Godot, matching case (usually pascal case)
* uid: The UID of the file where the class is defined
  * This can be skipped for built-in Godot classes
  * This can also be the path to a .tscn file (see the demo scene for more information)
* variables: This is where all variables you want to expose to Blender will be defined
  * only `@export` variables can be exposes
  * You do not need to expose all `@export` variables in a class to Blender
  * You can expose functions by appending "()" to the "var_name" field
    * The fuction should only take one input, whose type is defined by "type"
* type: A string of the Godot variable type
* default: A JSON primitive that will be converted to "type"
  * see "Things to Note" for more information
* description: A description of the variable
  * This is currently unused and can be omitted
* options: For enums, The string names and integer index for the enum
  * This should be omitted for everything but enum-type variables

#### Example `entity_template.json`
```
{
    "BTGExampleClass0": {
        "uid": "uid://cslerxu3gbk31",
        "variables": {
            "string_example": {
                "type": "String",
                "default": "string example",
                "description": "",
                "options": {}
            },
            "int_example": {
                "type": "int",
                "default": 1,
                "description": "",
                "options": {}
            },
            "vector_example": {
                "type": "Vector3",
                "default": [1, 2, 3],
                "description": "",
                "options": {}
            },
            "enum_example": {
                "type": "enum",
                "default": "OPTION_1",
                "description": "",
                "options": {"OPTION_1": 0, "OPTION_2": 1, "OPTION_3": 2}
            }
        }
    },
    "BTGExampleClass1": {
        "uid": "uid://cdw76g81jq3sk",
        "variables": {
            "float_example": {
                "type": "float",
                "default": 0.5
            },
            "custom_float()": {
                "type": "float",
                "default": 0.5
            }
        }
    },
    "Area3D": {
        "variables": {
            "angular_damp": {
                "type": "float",
                "default": 0.1,
                "description": "The rate at which objects stop spinning in this area.",
            }
        }
    }
}
```

#### Things to Note
* the `default` field
  * defaults for strings, ints, float, and bools are a 1:1 conversion
  * defaults for `Vector2` should be a 2-element list, and defaults for `Vector3` should be a 3-element list
  * defaults for `enum` should be a set of name-value pairs where the name is the enum string and the value is the `int` it represents in Godot.
* The Blender extension has a catch-all for unknown entries in the `type` field. If you enter a value that is not one of the above, it will be interpreted as a string
* You can input the name of a function in place of "var_name" (see "custom_float()" in the example above)
  * `type` becomes the type of the input. There should be only one required input for functions you expose to Blender

## BTG Import JSON
Once you have written your `entity_template.json`, imported it into your Blender project, and assigned your classes, you are ready to write the import JSON.

A Generated `entity_definition.json` may look something like this:
```
{
    "Cube": {
        "class": "BTGExampleClass0",
        "uid": "uid://cslerxu3gbk31",
        "variables": {
            "string_example": {
                "type": "String",
                "value": "test string"
            },
            "int_example": {
                "type": "int",
                "value": 4
            },
            "vector_example": {
                "type": "Vector3",
                "value": "(5.0, 6.0, 7.0)"
            },
            "enum_example": {
                "type": "enum",
                "value": 1
            }
        }
    },
    "Cube_001": {
        "class": "BTGExampleClass1",
        "uid": "uid://cdw76g81jq3sk",
        "variables": {
            "float_example": {
                "type": "float",
                "value": 0.5
            },
            "custom_float()": {
                "type": "float",
                "value": 0.5
            }
        }
    },
    "Icosphere": {
        "class": "Area3D",
        "variables": {
            "angular_damp": {
                "type": "float",
                "value": "0.82",
            }
        }
    }
}
```
#### Things to Note
* Each `.blend` will generate its own `entity_definition.json` which will need to be added to the "Entity Definition" field in the import settings for the respective model
* If your class does not have a `mesh` variable, the mesh of the Blender object will be lost. If you do not intend for an object to have a mesh, use Blender's [empties](https://docs.blender.org/manual/en/latest/modeling/empties.html)
* If you don't want to store the mesh, but want it for setting other values (for example, getting its AABB), you can implement the following:
  ```
  var mesh :
      set(value):
          # Your code here
  ```

#### Automatic Exporting/Importing
* using `.blend` files and the "export on save" option in Blender allows for automatic exporting and importing
  * Selecting "export on save" will export your `entity_definition.json` every time you save
  * Godot re-imports `.blend` files on every save, meaning your `entity_definition.json` will be read by Godot every time you save in Blender
* It's a good idea to develop and test your levels as `.blend` and then, upon finishing, export as `.glb`

## Useful Tools and Add-ons
These are some useful links for setting up Blender as a level editor
* [Source-Style Level Design in Blender Tutorial](https://www.reddit.com/r/godot/comments/1g6k38h/sourcestyle_level_design_in_blender_tutorial/?rdt=38457) - a tutorial for a great workflow
* [DreamUV](https://github.com/leukbaars/DreamUV) - very useful for UV editing
* [Texel Density Checker](https://extensions.blender.org/add-ons/texel-density-checker/) - also very useful for UV editing
* [Godot import hints](https://docs.godotengine.org/en/4.1/tutorials/assets_pipeline/importing_scenes.html#import-hints) - import hints for automatic collision generation and other good things
* Blender's [Linking](https://docs.blender.org/manual/en/latest/files/linked_libraries/link_append.html) can be very useful with BTG
  * For linking two BTG models:
    1. Select `File > Link...` and select the model you want to import
    3. Right click the object in the outliner and select `Library Override > Make > Selected`
  * Note: if you don't see the BTG options when selecting a linked model in the editor, the export script won't find it either. You may need to override multiple levels
  * To edit the imported model's BTG variables locally, you'll need to override each object individually


## Current Limitations
* There is not way to automatically convert a Bleder primitive shape to a Godot primitive shape
* The addon does not work with (alt+d) instanced objects. Each instance will have its own separate set of BTG class/variable values
* This addon does not work very well with the asset library. Importing a model with a BTG definition as an asset is tricky and convoluted


## The Demo Scene
Please take a look at the demo scene in `btg_entity_importer`, which contains examples of everything discussed in this readme!